generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id        String   @id @default(uuid())
  name      String
  email     String   @unique
  avatarUrl String?
  timezone  String   @default("America/Sao_Paulo")
  locale    String   @default("pt-BR")
  createdAt DateTime @default(now())
  
  workspaces Workspace[]
  fileMeta   FileMeta[]
  participantRecords Participant[]
}

model Workspace {
  id          String   @id @default(uuid())
  name        String
  ownerUserId String
  planId      String // "free" | "pro" | "family"
  createdAt   DateTime @default(now())

  owner User   @relation(fields: [ownerUserId], references: [id])
  trips Trip[]
  fileMeta FileMeta[]
  
  @@index([ownerUserId])
}

model Trip {
  id          String   @id @default(uuid())
  workspaceId String
  name        String
  destination String
  startDate   String // ISO_DATE
  endDate     String // ISO_DATE
  coverImageUrl String?
  type          String   @default("lazer")
  budget        Float?
  defaultCurrency String @default("BRL")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace     Workspace      @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  stays         Stay[]
  itineraryDays ItineraryDay[]
  reservations  Reservation[]
  participants  Participant[]
  expenses      Expense[]
  checklistItems ChecklistItem[]
  invites       TripInvite[]
  auditLogs     AuditLog[]
  
  @@index([workspaceId])
  @@map("trips")
}

model Stay {
  id        String   @id @default(uuid())
  tripId    String
  name      String
  startDate String   // ISO_DATE
  endDate   String   // ISO_DATE
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  trip      Trip     @relation(fields: [tripId], references: [id], onDelete: Cascade)

  @@index([tripId])
  @@map("stays")
}

model ChecklistItem {
  id        String   @id @default(uuid())
  tripId    String
  text      String
  isChecked Boolean  @default(false)
  createdAt DateTime @default(now())

  trip      Trip     @relation(fields: [tripId], references: [id], onDelete: Cascade)

  @@map("checklist_items")
}

model ItineraryDay {
  id        String   @id @default(uuid())
  tripId    String
  date      String // ISO_DATE
  title     String?
  createdAt DateTime @default(now())

  trip       Trip       @relation(fields: [tripId], references: [id], onDelete: Cascade)
  activities Activity[]

  @@unique([tripId, date])
  @@index([tripId])
}

model Activity {
  id           String   @id @default(uuid())
  dayId        String
  title        String
  timeStart    String? // TIME_HH_MM
  timeEnd      String? // TIME_HH_MM
  locationName String?
  address      String?
  mapUrl       String?
  cost         Float?
  currency     String?
  notes        String?
  latitude     Float?
  longitude    Float?
  orderIndex   Int
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  day      ItineraryDay @relation(fields: [dayId], references: [id], onDelete: Cascade)

  @@index([dayId])
}

enum ReservationType {
  flight
  hotel
  car
  train
  bus
  restaurant
  tour
  other
}

enum ReservationStatus {
  confirmed
  pending
  canceled
}

model Reservation {
  id               String            @id @default(uuid())
  tripId           String
  type             ReservationType
  title            String
  provider         String?
  confirmationCode String?
  startDateTime    DateTime // ISO_DATETIME
  endDateTime      DateTime? // ISO_DATETIME
  address          String?
  mapUrl           String?
  price            Float?
  currency         String
  status           ReservationStatus
  attachmentFileId String?
  notes            String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt

  trip     Trip       @relation(fields: [tripId], references: [id], onDelete: Cascade)

  @@index([tripId])
  @@index([startDateTime])
}

model FileMeta {
  id            String   @id @default(uuid())
  workspaceId   String
  ownerUserId   String
  path          String
  mimeType      String
  sizeBytes     Int
  originalName  String
  createdAt     DateTime @default(now())
  
  workspace   Workspace    @relation(fields: [workspaceId], references: [id])
  user        User         @relation(fields: [ownerUserId], references: [id])

  @@index([workspaceId])
  @@index([ownerUserId])
}

model Participant {
  id        String  @id @default(uuid())
  tripId    String
  userId    String?
  name      String
  email     String?
  isOwner   Boolean @default(false)
  role      String  @default("editor") // "owner" | "editor" | "viewer"
  
  trip      Trip    @relation(fields: [tripId], references: [id], onDelete: Cascade)
  user      User?   @relation(fields: [userId], references: [id])
  
  expensesPaid Expense[]
  expenseShares ExpenseShare[]

  @@index([tripId])
  @@index([userId])
}

model Expense {
  id                  String   @id @default(uuid())
  tripId              String
  title               String
  amount              Float
  currency            String   @default("BRL")
  paidByParticipantId String
  date                DateTime @default(now())
  category            String?
  createdAt           DateTime @default(now())

  trip     Trip        @relation(fields: [tripId], references: [id], onDelete: Cascade)
  paidBy   Participant @relation(fields: [paidByParticipantId], references: [id])
  shares   ExpenseShare[]

  @@index([tripId])
  @@index([paidByParticipantId])
}

model ExpenseShare {
  id            String  @id @default(uuid())
  expenseId     String
  participantId String
  amount        Float
  isPaid        Boolean @default(false)

  expense     Expense     @relation(fields: [expenseId], references: [id], onDelete: Cascade)
  participant Participant @relation(fields: [participantId], references: [id], onDelete: Cascade)

  @@index([expenseId])
  @@index([participantId])
}

model TripInvite {
  id        String   @id @default(uuid())
  tripId    String
  token     String   @unique @default(uuid())
  role      String   @default("editor")
  expiresAt DateTime
  createdAt DateTime @default(now())

  trip Trip @relation(fields: [tripId], references: [id], onDelete: Cascade)

  @@index([token])
}

model AuditLog {
  id        String   @id @default(uuid())
  tripId    String
  userId    String?
  userName  String?
  action    String
  entity    String
  entityId  String?
  details   String?
  createdAt DateTime @default(now())

  trip Trip @relation(fields: [tripId], references: [id], onDelete: Cascade)

  @@index([tripId])
}
